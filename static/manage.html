<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Sora2API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .animate-slide-up {
            animation: slide-up .3s ease-out
        }

        .tab-btn {
            transition: all .2s ease
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { border: "hsl(0 0% 89%)", input: "hsl(0 0% 89%)", ring: "hsl(0 0% 3.9%)", background: "hsl(0 0% 100%)", foreground: "hsl(0 0% 3.9%)", primary: { DEFAULT: "hsl(0 0% 9%)", foreground: "hsl(0 0% 98%)" }, secondary: { DEFAULT: "hsl(0 0% 96.1%)", foreground: "hsl(0 0% 9%)" }, muted: { DEFAULT: "hsl(0 0% 96.1%)", foreground: "hsl(0 0% 45.1%)" }, destructive: { DEFAULT: "hsl(0 84.2% 60.2%)", foreground: "hsl(0 0% 98%)" } } } } }
    </script>
</head>

<body class="h-full bg-background text-foreground antialiased">
    <!-- Navigation Bar -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-baseline gap-3">
                <span class="font-bold text-xl">Sora2API</span>
            </div>
            <div class="flex flex-1 items-center justify-end gap-3">
                <a href="https://github.com/TheSmallHanCat/sora2api" target="_blank"
                    class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5"
                    title="GitHub Repository">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                </a>
                <button onclick="logout()"
                    class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <!-- Tab Navigation -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('tokens')" id="tabTokens"
                    class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">Token Management</button>
                <button onclick="switchTab('settings')" id="tabSettings"
                    class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">System Settings</button>
                <button onclick="switchTab('logs')" id="tabLogs"
                    class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Request Logs</button>
                <button onclick="switchTab('generate')" id="tabGenerate"
                    class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Generation
                    Panel</button>
            </nav>
        </div>

        <!-- Token Management Panel -->
        <div id="panelTokens">
            <!-- Statistic Cards -->
            <div class="grid gap-4 grid-cols-2 md:grid-cols-5 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Total Tokens</p>
                    <h3 class="text-xl font-bold" id="statTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Active Tokens</p>
                    <h3 class="text-xl font-bold text-green-600" id="statActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Today's Images / Total Images</p>
                    <h3 class="text-xl font-bold text-blue-600" id="statImages">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Today's Videos / Total Videos</p>
                    <h3 class="text-xl font-bold text-purple-600" id="statVideos">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Today's Errors / Total Errors</p>
                    <h3 class="text-xl font-bold text-destructive" id="statErrors">-</h3>
                </div>
            </div>

            <!-- Token List -->
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Token List</h3>
                    <div class="flex items-center gap-3">
                        <!-- Auto-refresh AT label and switch -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-muted-foreground">Auto-refresh AT</span>
                            <div class="relative inline-flex items-center group">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="atAutoRefreshToggle" onchange="toggleATAutoRefresh()"
                                        class="sr-only peer">
                                    <div
                                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                    </div>
                                </label>
                                <!-- Tooltip -->
                                <div
                                    class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs rounded px-2 py-1 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Automatically refresh AT using ST or RT when token expiration is within 24h
                                    <div
                                        class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="refreshTokens()"
                            class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8"
                            title="Refresh">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10" />
                                <polyline points="1 20 1 14 7 14" />
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                            </svg>
                        </button>
                        <!-- Batch actions dropdown -->
                        <style>
                            .batch-dropdown-container {
                                position: relative;
                                display: inline-block;
                            }

                            .batch-dropdown-btn {
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                height: 32px;
                                padding: 0 12px;
                                background: #6366f1;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            }

                            .batch-dropdown-btn:hover {
                                background: #4f46e5;
                            }

                            .batch-dropdown-arrow {
                                margin-left: 4px;
                                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            }

                            .batch-dropdown-container:hover .batch-dropdown-arrow {
                                transform: rotate(180deg);
                            }

                            .batch-dropdown-menu {
                                position: absolute;
                                top: calc(100% + 4px);
                                left: 0;
                                min-width: 160px;
                                background: white;
                                border-radius: 6px;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                                z-index: 50;
                                opacity: 0;
                                visibility: hidden;
                                transform: translateY(-8px);
                                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                                overflow: hidden;
                            }

                            .batch-dropdown-container:hover .batch-dropdown-menu {
                                opacity: 1;
                                visibility: visible;
                                transform: translateY(0);
                            }

                            .batch-dropdown-item {
                                display: flex;
                                align-items: center;
                                width: 100%;
                                padding: 8px 12px;
                                border: none;
                                background: none;
                                color: #374151;
                                font-size: 13px;
                                text-align: left;
                                cursor: pointer;
                                transition: background 0.15s ease;
                            }

                            .batch-dropdown-item:hover {
                                background: #f3f4f6;
                            }

                            .batch-dropdown-item.purple:hover {
                                background: #faf5ff;
                                color: #9333ea;
                            }

                            .batch-dropdown-item.teal:hover {
                                background: #f0fdfa;
                                color: #0d9488;
                            }

                            .batch-dropdown-item.orange:hover {
                                background: #fff7ed;
                                color: #ea580c;
                            }

                            .batch-dropdown-item.red:hover {
                                background: #fef2f2;
                                color: #dc2626;
                            }

                            .batch-dropdown-item.blue:hover {
                                background: #eff6ff;
                                color: #2563eb;
                            }

                            .batch-dropdown-item+.batch-dropdown-item {
                                border-top: 1px solid #f3f4f6;
                            }

                            .batch-dropdown-icon {
                                width: 14px;
                                height: 14px;
                                margin-right: 8px;
                            }
                        </style>
                        <div class="batch-dropdown-container">
                            <button class="batch-dropdown-btn" title="Batch Actions">
                                <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4" />
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                                </svg>
                                <span class="text-sm font-medium">Batch Actions</span>
                                <svg class="batch-dropdown-arrow h-3 w-3" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9" />
                                </svg>
                            </button>
                            <div class="batch-dropdown-menu">
                                <button onclick="batchTestUpdate()" class="batch-dropdown-item purple"
                                    title="Test update all tokens in one click">
                                    <svg class="batch-dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                        <polyline points="22 4 12 14.01 9 11.01" />
                                    </svg>
                                    <span>Test & Update</span>
                                </button>
                                <button onclick="batchEnableAll()" class="batch-dropdown-item teal"
                                    title="Enable all disabled tokens in one click">
                                    <svg class="batch-dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 11l3 3L22 4" />
                                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                                    </svg>
                                    <span>Enable Selected</span>
                                </button>
                                <button onclick="batchDisableSelected()" class="batch-dropdown-item orange"
                                    title="Disable selected tokens">
                                    <svg class="batch-dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="15" y1="9" x2="9" y2="15" />
                                        <line x1="9" y1="9" x2="15" y2="15" />
                                    </svg>
                                    <span>Disable Selected</span>
                                </button>
                                <button onclick="batchDeleteDisabled()" class="batch-dropdown-item red"
                                    title="Clean up all disabled tokens">
                                    <svg class="batch-dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6" />
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                    </svg>
                                    <span>Delete Disabled</span>
                                </button>
                                <button onclick="openBatchProxyModal()" class="batch-dropdown-item blue"
                                    title="Update selected token proxies in bulk">
                                    <svg class="batch-dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3" />
                                        <path
                                            d="M12 1v6m0 6v6m-5.2-9.8l4.2 4.2m4.2 0l4.2-4.2m-12.6 0l4.2 4.2m4.2 0l4.2 4.2" />
                                    </svg>
                                    <span>Update Proxy</span>
                                </button>
                            </div>
                        </div>
                        <button onclick="exportTokens()"
                            class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 h-8 px-3"
                            title="Export all tokens">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            <span class="text-sm font-medium">Export</span>
                        </button>
                        <button onclick="openImportModal()"
                            class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 h-8 px-3"
                            title="Import tokens">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            <span class="text-sm font-medium">Import</span>
                        </button>
                        <button onclick="openAddModal()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            <span class="text-sm font-medium">Add</span>
                        </button>
                    </div>
                </div>

                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"
                                        class="h-4 w-4 rounded border-gray-300">
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Email
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Status
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Client ID
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">
                                    Expiration</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Account
                                    Type</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Remaining
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Images
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Videos
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Errors
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Notes
                                </th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tokenTableBody" class="divide-y divide-border">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div id="paginationContainer"></div>
            </div>
        </div>

        <!-- System Settings Panel -->
        <div id="panelSettings" class="hidden">
            <div class="grid gap-6 lg:grid-cols-2">
                <!-- Security Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Security Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Admin Username</label>
                            <input id="cfgAdminUsername" type="text"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                            <p class="text-xs text-muted-foreground mt-1">Admin username</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">Current Password</label>
                            <input id="cfgOldPassword" type="password"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="Enter current password">
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">New Password</label>
                            <input id="cfgNewPassword" type="password"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="Enter new password">
                        </div>
                        <button onclick="updateAdminPassword()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Change
                            Password</button>
                    </div>
                </div>

                <!-- API Key Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">API Key Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Current API Key</label>
                            <input id="cfgCurrentAPIKey" type="text"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                readonly disabled>
                            <p class="text-xs text-muted-foreground mt-1">Currently used API key (read-only)</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">New API Key</label>
                            <input id="cfgNewAPIKey" type="text"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="Enter new API Key">
                            <p class="text-xs text-muted-foreground mt-1">Key used by clients when calling the API</p>
                        </div>
                        <button onclick="updateAPIKey()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Update
                            API Key</button>
                    </div>
                </div>

                <!-- Proxy Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Proxy Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgProxyEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Enable proxy</span>
                            </label>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">Proxy URL</label>
                            <input id="cfgProxyUrl"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="http://127.0.0.1:7890 or socks5://127.0.0.1:1080">
                            <p class="text-xs text-muted-foreground mt-1">Supports HTTP and SOCKS5 proxies</p>
                        </div>
                        <button onclick="saveProxyConfig()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save
                            Settings</button>
                    </div>
                </div>

                <!-- Error Handling Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Error Handling Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Error ban threshold</label>
                            <input id="cfgErrorBan" type="number"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="3">
                            <p class="text-xs text-muted-foreground mt-1">Tokens with consecutive errors reaching this
                                count will be disabled automatically</p>
                        </div>
                        <button onclick="saveAdminConfig()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save
                            Settings</button>
                    </div>
                </div>

                <!-- Cache Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Cache Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgCacheEnabled" class="h-4 w-4 rounded border-input"
                                    onchange="toggleCacheOptions()">
                                <span class="text-sm font-medium">Enable caching</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-1">When disabled, generated images and videos
                                will return the source link directly without local caching</p>
                        </div>

                        <!-- Cache Options -->
                        <div id="cacheOptions" style="display: none;" class="space-y-4 pt-4 border-t border-border">
                            <div>
                                <label class="text-sm font-medium mb-2 block">Cache timeout (seconds)</label>
                                <input id="cfgCacheTimeout" type="number"
                                    class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    placeholder="7200" min="-1" max="86400">
                                <p class="text-xs text-muted-foreground mt-1">File cache timeout range: 60-86400 seconds
                                    (1 minute - 24 hours), -1 means never auto-delete</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">Cache access domain</label>
                                <input id="cfgCacheBaseUrl" type="text"
                                    class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    placeholder="https://yourdomain.com">
                                <p class="text-xs text-muted-foreground mt-1">Leave blank to use the server address,
                                    e.g., https://yourdomain.com</p>
                            </div>
                            <div id="cacheEffectiveUrl" class="rounded-md bg-muted p-3 hidden">
                                <p class="text-xs text-muted-foreground">
                                    <strong>üåê Effective access URL:</strong><code id="cacheEffectiveUrlValue"
                                        class="bg-background px-1 py-0.5 rounded"></code>
                                </p>
                            </div>
                        </div>

                        <button onclick="saveCacheConfig()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save
                            Settings</button>
                    </div>
                </div>

                <!-- Generation Timeout Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Generation Timeout Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Image generation timeout (seconds)</label>
                            <input id="cfgImageTimeout" type="number"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="300" min="60" max="3600">
                            <p class="text-xs text-muted-foreground mt-1">Image generation timeout range: 60-3600
                                seconds (1 minute - 1 hour). Token locks are released after timeout.</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">Video generation timeout (seconds)</label>
                            <input id="cfgVideoTimeout" type="number"
                                class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                placeholder="1500" min="60" max="7200">
                            <p class="text-xs text-muted-foreground mt-1">Video generation timeout range: 60-7200
                                seconds (1 minute - 2 hours). Times out with upstream API error.</p>
                        </div>
                        <button onclick="saveGenerationTimeout()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save
                            Settings</button>
                    </div>
                </div>

                <!-- Watermark-free Mode Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Watermark-free Mode Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgWatermarkFreeEnabled" class="h-4 w-4 rounded border-input"
                                    onchange="toggleWatermarkFreeOptions()">
                                <span class="text-sm font-medium">Enable watermark-free mode</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">When enabled, generated videos will be
                                published to the Sora platform to extract watermark-free versions, then cached locally
                                and removed from the platform.</p>
                        </div>

                        <!-- Parsing Options -->
                        <div id="watermarkFreeOptions" style="display: none;"
                            class="space-y-4 pt-4 border-t border-border">
                            <div>
                                <label class="text-sm font-medium">Parsing method</label>
                                <select id="cfgParseMethod"
                                    class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground"
                                    onchange="toggleCustomParseOptions()">
                                    <option value="third_party">Third-party parsing</option>
                                    <option value="custom">Android API (in-container)</option>
                                </select>
                            </div>

                            <!-- Custom Parsing Settings -->
                            <div id="customParseOptions" style="display: none;" class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium">Android Access Token</label>
                                    <textarea id="cfgAndroidAuthToken" rows="2"
                                        class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground font-mono"
                                        placeholder="Paste Android Access Token (Bearer)"></textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium">Android Refresh Token</label>
                                    <textarea id="cfgAndroidRefreshToken" rows="2"
                                        class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground font-mono"
                                        placeholder="Paste Android Refresh Token"></textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium">Android Client ID</label>
                                    <input type="text" id="cfgAndroidClientId"
                                        class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground font-mono"
                                        placeholder="app_OHnYmJt5u1XEdhDUx0ig1ziv">
                                    <p class="text-xs text-muted-foreground mt-1">Default: <code
                                            class="bg-muted px-1 py-0.5 rounded">app_OHnYmJt5u1XEdhDUx0ig1ziv</code>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button onclick="saveWatermarkFreeConfig()"
                            class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 w-full">Save
                            Settings</button>
                    </div>
                </div>

                <!-- Debug Settings -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <h3 class="text-lg font-semibold mb-4">Debug Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgDebugEnabled" class="h-4 w-4 rounded border-input"
                                    onchange="toggleDebugMode()">
                                <span class="text-sm font-medium">Enable debug mode</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">When enabled, detailed upstream API
                                request/response logs will be written to <code
                                    class="bg-muted px-1 py-0.5 rounded">logs.txt</code> immediately.</p>
                        </div>
                        <div>
                            <button onclick="downloadDebugLogs()"
                                class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 text-sm font-medium transition-colors">
                                <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Download log file
                            </button>
                            <p class="text-xs text-muted-foreground mt-2">Download the full debug log file (logs.txt)
                            </p>
                        </div>
                        <div
                            class="rounded-md bg-yellow-50 dark:bg-yellow-900/20 p-3 border border-yellow-200 dark:border-yellow-800">
                            <p class="text-xs text-yellow-800 dark:text-yellow-200">
                                ‚ö†Ô∏è <strong>Note:</strong> Debug mode generates a very large amount of logs. Enable only
                                for troubleshooting to avoid disk issues.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request Logs Panel -->
        <div id="panelLogs" class="hidden">
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Request Logs</h3>
                    <div class="flex gap-2">
                        <button onclick="clearAllLogs()"
                            class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-red-50 hover:text-red-700 h-8 px-3 text-sm"
                            title="Clear logs">
                            <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6" />
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                            </svg>
                            Clear
                        </button>
                        <button onclick="refreshLogs()"
                            class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8"
                            title="Refresh">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10" />
                                <polyline points="1 20 1 14 7 14" />
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="relative w-full overflow-auto max-h-[600px]">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-background">
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-32">
                                    Operation</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-40">
                                    Token Email</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-20">
                                    Status Code</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-32">
                                    Method</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-32">
                                    Progress</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-24">
                                    Duration (s)</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-44">Time
                                </th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-32">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-border">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Generation Panel (single layer embed spanning full width) -->
        <div id="panelGenerate" class="hidden" style="background: #ffffff;">
            <iframe id="generateFrame" src="/static/generate.html" class="w-full"
                style="border: 0; background: #ffffff; display:block; width:100%; height: 800px;"
                loading="lazy"></iframe>
        </div>

        <!-- Log Detail Modal -->
        <div id="logDetailModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
            <div
                class="bg-background rounded-lg border border-border w-full max-w-3xl shadow-xl max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between p-5 border-b border-border">
                    <h3 class="text-lg font-semibold">Log Details</h3>
                    <button onclick="closeLogDetailModal()" class="text-muted-foreground hover:text-foreground">
                        <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="p-5 overflow-y-auto">
                    <div id="logDetailContent" class="space-y-4">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-border text-center text-xs text-muted-foreground">
            <p>¬© 2025 <a href="https://linux.do/u/thesmallhancat/summary" target="_blank"
                    class="no-underline hover:underline" style="color: inherit;">TheSmallHanCat</a> && <a
                    href="https://linux.do/u/tibbar/summary" target="_blank" class="no-underline hover:underline"
                    style="color: inherit;">Tibbar</a>. All rights reserved.</p>
        </footer>
    </main>

    <!-- Add Token Modal -->
    <div id="addModal"
        class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">Add Token</h3>
                <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <!-- Access Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Access Token (AT) <span class="text-red-500">*</span></label>
                    <textarea id="addTokenAT" rows="3"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"
                        placeholder="Enter Access Token or convert via ST/RT below"></textarea>
                    <p class="text-xs text-muted-foreground">Format: eyJh... (JWT format)</p>
                </div>

                <!-- Session Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Session Token (ST) <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <div class="flex gap-2">
                        <textarea id="addTokenST" rows="2"
                            class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"
                            placeholder="Enter Session Token then click convert"></textarea>
                        <button onclick="convertST2AT()"
                            class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 px-4 whitespace-nowrap h-auto">
                            ST‚ÜíAT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">Retrieve __Secure-next-auth.session-token from browser
                        cookies</p>
                </div>

                <!-- Refresh Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Refresh Token (RT) <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <div class="flex gap-2">
                        <textarea id="addTokenRT" rows="2"
                            class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"
                            placeholder="Enter Refresh Token then click convert"></textarea>
                        <button onclick="convertRT2AT()"
                            class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 px-4 whitespace-nowrap h-auto">
                            RT‚ÜíAT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">Obtain from mobile or other clients</p>
                    <p id="addRTRefreshHint" class="text-xs text-green-600 font-medium hidden">‚úì RT refreshed and
                        updated</p>
                </div>

                <!-- Client ID -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Client ID <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <input id="addTokenClientId"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono"
                        placeholder="Leave blank to use default">
                    <p class="text-xs text-muted-foreground">Used for RT refresh; leave blank to use the default Client
                        ID</p>
                </div>

                <!-- Proxy URL -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Proxy <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <input id="addTokenProxyUrl"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono"
                        placeholder="http://127.0.0.1:7890 or socks5://127.0.0.1:1080">
                    <p class="text-xs text-muted-foreground">Supports HTTP and SOCKS5 proxies; leave blank to use the
                        system proxy</p>
                </div>

                <!-- Remark -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Notes <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <input id="addTokenRemark"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        placeholder="Add remark information">
                </div>

                <!-- Feature Toggles -->
                <div class="space-y-3 pt-2 border-t border-border">
                    <label class="text-sm font-medium">Feature Toggles</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenImageEnabled" checked
                                    class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Enable image generation</span>
                            </label>
                            <input type="number" id="addTokenImageConcurrency" value="1"
                                class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm"
                                placeholder="Concurrency"
                                title="Concurrency limit: sets the maximum simultaneous requests. -1 for unlimited">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenVideoEnabled" checked
                                    class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Enable video generation</span>
                            </label>
                            <input type="number" id="addTokenVideoConcurrency" value="3"
                                class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm"
                                placeholder="Concurrency"
                                title="Concurrency limit: sets the maximum simultaneous requests. -1 for unlimited">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeAddModal()"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="addTokenBtn" onclick="submitAddToken()"
                    class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="addTokenBtnText">Add</span>
                    <svg id="addTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Token Modal -->
    <div id="editModal"
        class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">Edit Token</h3>
                <button onclick="closeEditModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <input type="hidden" id="editTokenId">

                <!-- Access Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Access Token (AT) <span class="text-red-500">*</span></label>
                    <textarea id="editTokenAT" rows="3"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"
                        placeholder="Enter Access Token or convert via ST/RT below"></textarea>
                    <p class="text-xs text-muted-foreground">Format: eyJh... (JWT format)</p>
                </div>

                <!-- Session Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Session Token (ST) <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <div class="flex gap-2">
                        <textarea id="editTokenST" rows="2"
                            class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"
                            placeholder="Enter Session Token then click convert"></textarea>
                        <button onclick="convertEditST2AT()"
                            class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 px-4 whitespace-nowrap h-auto">
                            ST‚ÜíAT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">Retrieve __Secure-next-auth.session-token from browser
                        cookies</p>
                </div>

                <!-- Refresh Token -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Refresh Token (RT) <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <div class="flex gap-2">
                        <textarea id="editTokenRT" rows="2"
                            class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none"
                            placeholder="Enter Refresh Token then click convert"></textarea>
                        <button onclick="convertEditRT2AT()"
                            class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 px-4 whitespace-nowrap h-auto">
                            RT‚ÜíAT
                        </button>
                    </div>
                    <p class="text-xs text-muted-foreground">Obtain from mobile or other clients</p>
                    <p id="editRTRefreshHint" class="text-xs text-green-600 font-medium hidden">‚úì RT refreshed and
                        updated</p>
                </div>

                <!-- Client ID -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Client ID <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <input id="editTokenClientId"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono"
                        placeholder="Leave blank to use default">
                    <p class="text-xs text-muted-foreground">Used for RT refresh; leave blank to use the default Client
                        ID</p>
                </div>

                <!-- Proxy URL -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Proxy <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <input id="editTokenProxyUrl"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono"
                        placeholder="http://127.0.0.1:7890 or socks5://127.0.0.1:1080">
                    <p class="text-xs text-muted-foreground">Supports HTTP and SOCKS5 proxies; leave blank to use the
                        system proxy</p>
                </div>

                <!-- Remark -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Notes <span class="text-muted-foreground text-xs">-
                            Optional</span></label>
                    <input id="editTokenRemark"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        placeholder="Add remark information">
                </div>

                <!-- Feature Toggles -->
                <div class="space-y-3 pt-2 border-t border-border">
                    <label class="text-sm font-medium">Feature Toggles</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenImageEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Enable image generation</span>
                            </label>
                            <input type="number" id="editTokenImageConcurrency"
                                class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm"
                                placeholder="Concurrency"
                                title="Concurrency limit: sets the maximum simultaneous requests. -1 for unlimited">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenVideoEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">Enable video generation</span>
                            </label>
                            <input type="number" id="editTokenVideoConcurrency"
                                class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm"
                                placeholder="Concurrency"
                                title="Concurrency limit: sets the maximum simultaneous requests. -1 for unlimited">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeEditModal()"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="editTokenBtn" onclick="submitEditToken()"
                    class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="editTokenBtnText">Save</span>
                    <svg id="editTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Token Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">Import Tokens</h3>
                <button onclick="closeImportModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">Select JSON file</label>
                    <input type="file" id="importFile" accept=".json"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    <p class="text-xs text-muted-foreground mt-1">Choose an exported token JSON file to import</p>
                </div>
                <div>
                    <label class="text-sm font-medium mb-2 block">Select import mode</label>
                    <select id="importMode" onchange="updateImportModeHint()"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                        <option value="at">Import with AT (recommended)</option>
                        <option value="offline">Offline import (do not update status)</option>
                        <option value="st">Convert via ST first</option>
                        <option value="rt">Convert via RT first</option>
                    </select>
                    <p id="importModeHint" class="text-xs text-muted-foreground mt-1">Use AT to refresh account info
                        (subscription, Sora2 usage, etc.)</p>
                </div>
                <div class="rounded-md bg-gray-50 dark:bg-gray-900/20 p-3 border border-gray-200 dark:border-gray-800">
                    <p class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2">üìã Import mode details</p>
                    <div class="space-y-1.5 text-xs text-gray-700 dark:text-gray-300">
                        <div class="flex items-start gap-2">
                            <span class="font-medium min-w-[100px]">AT import:</span>
                            <span>Fully updates all account information (recommended)</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-medium min-w-[100px]">Offline import:</span>
                            <span>Insert directly into DB without API calls; account data must be refreshed
                                separately</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-medium min-w-[100px]">ST import:</span>
                            <span>For ST-only data, auto-converts to AT</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-medium min-w-[100px]">RT import:</span>
                            <span>For RT-only data, auto-converts to AT</span>
                        </div>
                    </div>
                    <p
                        class="text-xs text-gray-600 dark:text-gray-400 mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                        üí° Tip: after offline import, click ‚ÄúTest‚Äù to refresh account info. Feature may be unstable;
                        ping the maintainer if issues arise.
                    </p>
                </div>
                <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                    <p class="text-xs text-blue-800 dark:text-blue-200">
                        <strong>Note:</strong> Existing emails will be updated; new ones will be inserted
                    </p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeImportModal()"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="importBtn" onclick="submitImportTokens()"
                    class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="importBtnText">Import</span>
                    <svg id="importBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="importProgressModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div
            class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">Import Progress</h3>
                <button onclick="closeImportProgressModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="p-5 overflow-y-auto flex-1">
                <div id="importProgressSummary" class="mb-4 p-3 rounded-md bg-muted"></div>
                <div id="importProgressList" class="space-y-2"></div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeImportProgressModal()"
                    class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">Close</button>
            </div>
        </div>
    </div>

    <!-- Batch Proxy Modal -->
    <div id="batchProxyModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">Update Proxy in Bulk</h3>
                <button onclick="closeBatchProxyModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">Proxy URL</label>
                    <input type="text" id="batchProxyUrl"
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        placeholder="http://127.0.0.1:7890 or socks5://127.0.0.1:1080">
                    <p class="text-xs text-muted-foreground mt-1">Supports HTTP and SOCKS5 proxies; leave blank to clear
                        proxy settings</p>
                </div>
                <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                    <p class="text-xs text-blue-900 dark:text-blue-100">
                        <span class="font-semibold">Note:</span> Proxy will be updated for <span id="batchProxyCount"
                            class="font-semibold">0</span> selected tokens
                    </p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeBatchProxyModal()"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">Cancel</button>
                <button id="batchProxyBtn" onclick="submitBatchProxy()"
                    class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <svg id="batchProxyBtnSpinner" class="hidden animate-spin -ml-1 mr-2 h-4 w-4"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span id="batchProxyBtnText">Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let allTokens = [], currentPage = 1, pageSize = 20, selectedTokenIds = new Set();
        const $ = (id) => document.getElementById(id),
            checkAuth = () => { const t = localStorage.getItem('adminToken'); return t || (location.href = '/login', null), t },
            apiRequest = async (url, opts = {}) => { const t = checkAuth(); if (!t) return null; const r = await fetch(url, { ...opts, headers: { ...opts.headers, Authorization: `Bearer ${t}`, 'Content-Type': 'application/json' } }); return r.status === 401 ? (localStorage.removeItem('adminToken'), location.href = '/login', null) : r },
            loadStats = async () => { try { const r = await apiRequest('/api/stats'); if (!r) return; const d = await r.json(); $('statTotal').textContent = d.total_tokens || 0; $('statActive').textContent = d.active_tokens || 0; $('statImages').textContent = (d.today_images || 0) + '/' + (d.total_images || 0); $('statVideos').textContent = (d.today_videos || 0) + '/' + (d.total_videos || 0); $('statErrors').textContent = (d.today_errors || 0) + '/' + (d.total_errors || 0) } catch (e) { console.error('Failed to load stats:', e) } },
            loadTokens = async () => { try { const r = await apiRequest('/api/tokens'); if (!r) return; allTokens = await r.json(); renderTokens() } catch (e) { console.error('Failed to load tokens:', e) } },
            formatExpiry = exp => { if (!exp) return '-'; const d = new Date(exp), now = new Date(), diff = d - now; const dateStr = d.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-'); const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); if (diff < 0) return `<span class="text-red-600">${dateStr} ${timeStr}</span>`; const days = Math.floor(diff / 864e5); if (days < 7) return `<span class="text-orange-600">${dateStr} ${timeStr}</span>`; return `${dateStr} ${timeStr}` },
            formatPlanType = type => { if (!type) return '-'; const typeMap = { 'chatgpt_team': 'Team', 'chatgpt_plus': 'Plus', 'chatgpt_pro': 'Pro', 'chatgpt_free': 'Free' }; return typeMap[type] || type },
            formatPlanTypeWithTooltip = (t) => { const tooltipText = t.subscription_end ? `Plan expires: ${new Date(t.subscription_end).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-')} ${new Date(t.subscription_end).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })}` : ''; return `<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-blue-50 text-blue-700 cursor-pointer" title="${tooltipText || t.plan_title || '-'}">${formatPlanType(t.plan_type)}</span>` },
            formatClientId = (clientId) => { if (!clientId) return '-'; const short = clientId.substring(0, 8) + '...'; return `<span class="text-xs font-mono cursor-pointer hover:text-primary" title="${clientId}" onclick="navigator.clipboard.writeText('${clientId}').then(()=>showToast('Copied','success'))">${short}</span>` },
            renderTokens = () => { const start = (currentPage - 1) * pageSize, end = start + pageSize, paginatedTokens = allTokens.slice(start, end); const tb = $('tokenTableBody'); tb.innerHTML = paginatedTokens.map(t => { const imageDisplay = t.image_enabled ? `${t.image_count || 0}` : '-'; const videoDisplay = t.video_enabled ? `${t.video_count || 0}` : '-'; const remainingCount = t.sora2_remaining_count !== undefined && t.sora2_remaining_count !== null ? t.sora2_remaining_count : '-'; const statusText = t.is_expired ? 'Expired' : (t.is_active ? 'Active' : 'Disabled'); const statusClass = t.is_expired ? 'bg-gray-100 text-gray-700' : (t.is_active ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-700'); return `<tr><td class=\"py-2.5 px-3\"><input type=\"checkbox\" class=\"token-checkbox h-4 w-4 rounded border-gray-300\" data-token-id=\"${t.id}\" onchange=\"toggleTokenSelection(${t.id},this.checked)\" ${selectedTokenIds.has(t.id) ? 'checked' : ''}></td><td class=\"py-2.5 px-3\">${t.email}</td><td class=\"py-2.5 px-3\"><span class=\"inline-flex items-center rounded px-2 py-0.5 text-xs ${statusClass}\">${statusText}</span></td><td class="py-2.5 px-3">${formatClientId(t.client_id)}</td><td class="py-2.5 px-3 text-xs">${formatExpiry(t.expiry_time)}</td><td class="py-2.5 px-3 text-xs">${formatPlanTypeWithTooltip(t)}</td><td class="py-2.5 px-3">${remainingCount}</td><td class="py-2.5 px-3">${imageDisplay}</td><td class="py-2.5 px-3">${videoDisplay}</td><td class="py-2.5 px-3">${t.error_count || 0}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${t.remark || '-'}</td><td class="py-2.5 px-3 text-right"><button onclick="testToken(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs mr-1">Test</button><button onclick="openEditModal(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-green-50 hover:text-green-700 h-7 px-2 text-xs mr-1">Edit</button><button onclick="toggleToken(${t.id},${t.is_active})" class="inline-flex items-center justify-center rounded-md hover:bg-accent h-7 px-2 text-xs mr-1">${t.is_active ? 'Disable' : 'Enable'}</button><button onclick="deleteToken(${t.id})" class="inline-flex items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive h-7 px-2 text-xs">Delete</button></td></tr>` }).join(''); renderPagination() },
            refreshTokens = async () => { await loadTokens(); await loadStats() },
            changePage = (page) => { currentPage = page; renderTokens() },
            changePageSize = (size) => { pageSize = parseInt(size); currentPage = 1; renderTokens() },
            renderPagination = () => { const totalPages = Math.ceil(allTokens.length / pageSize); const container = $('paginationContainer'); if (!container) return; let html = '<div class="flex items-center justify-between px-4 py-3 border-t border-border"><div class="flex items-center gap-2"><span class="text-sm text-muted-foreground">Rows per page</span><select onchange="changePageSize(this.value)" class="h-8 rounded-md border border-input bg-background px-2 text-sm"><option value="20"' + (pageSize === 20 ? ' selected' : '') + '>20</option><option value="50"' + (pageSize === 50 ? ' selected' : '') + '>50</option><option value="100"' + (pageSize === 100 ? ' selected' : '') + '>100</option><option value="200"' + (pageSize === 200 ? ' selected' : '') + '>200</option><option value="500"' + (pageSize === 500 ? ' selected' : '') + '>500</option></select><span class="text-sm text-muted-foreground">Total ' + allTokens.length + '</span></div><div class="flex items-center gap-2">'; if (totalPages > 1) { html += '<button onclick="changePage(1)" ' + (currentPage === 1 ? 'disabled' : '') + ' class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm disabled:opacity-50 disabled:cursor-not-allowed">First</button>'; html += '<button onclick="changePage(' + (currentPage - 1) + ')" ' + (currentPage === 1 ? 'disabled' : '') + ' class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>'; html += '<span class="text-sm text-muted-foreground">Page ' + currentPage + ' / ' + totalPages + '</span>'; html += '<button onclick="changePage(' + (currentPage + 1) + ')" ' + (currentPage === totalPages ? 'disabled' : '') + ' class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>'; html += '<button onclick="changePage(' + totalPages + ')" ' + (currentPage === totalPages ? 'disabled' : '') + ' class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm disabled:opacity-50 disabled:cursor-not-allowed">Last</button>' } html += '</div></div>'; container.innerHTML = html },
            openAddModal = () => $('addModal').classList.remove('hidden'),
            closeAddModal = () => { $('addModal').classList.add('hidden'); $('addTokenAT').value = ''; $('addTokenST').value = ''; $('addTokenRT').value = ''; $('addTokenClientId').value = ''; $('addTokenProxyUrl').value = ''; $('addTokenRemark').value = ''; $('addTokenImageEnabled').checked = true; $('addTokenVideoEnabled').checked = true; $('addTokenImageConcurrency').value = '1'; $('addTokenVideoConcurrency').value = '3'; $('addRTRefreshHint').classList.add('hidden') },
            openEditModal = (id) => { const token = allTokens.find(t => t.id === id); if (!token) return showToast('Token not found', 'error'); $('editTokenId').value = token.id; $('editTokenAT').value = token.token || ''; $('editTokenST').value = token.st || ''; $('editTokenRT').value = token.rt || ''; $('editTokenClientId').value = token.client_id || ''; $('editTokenProxyUrl').value = token.proxy_url || ''; $('editTokenRemark').value = token.remark || ''; $('editTokenImageEnabled').checked = token.image_enabled !== false; $('editTokenVideoEnabled').checked = token.video_enabled !== false; $('editTokenImageConcurrency').value = token.image_concurrency || '-1'; $('editTokenVideoConcurrency').value = token.video_concurrency || '-1'; $('editModal').classList.remove('hidden') },
            closeEditModal = () => { $('editModal').classList.add('hidden'); $('editTokenId').value = ''; $('editTokenAT').value = ''; $('editTokenST').value = ''; $('editTokenRT').value = ''; $('editTokenClientId').value = ''; $('editTokenProxyUrl').value = ''; $('editTokenRemark').value = ''; $('editTokenImageEnabled').checked = true; $('editTokenVideoEnabled').checked = true; $('editTokenImageConcurrency').value = ''; $('editTokenVideoConcurrency').value = ''; $('editRTRefreshHint').classList.add('hidden') },
            submitEditToken = async () => { const id = parseInt($('editTokenId').value), at = $('editTokenAT').value.trim(), st = $('editTokenST').value.trim(), rt = $('editTokenRT').value.trim(), clientId = $('editTokenClientId').value.trim(), proxyUrl = $('editTokenProxyUrl').value.trim(), remark = $('editTokenRemark').value.trim(), imageEnabled = $('editTokenImageEnabled').checked, videoEnabled = $('editTokenVideoEnabled').checked, imageConcurrency = $('editTokenImageConcurrency').value ? parseInt($('editTokenImageConcurrency').value) : null, videoConcurrency = $('editTokenVideoConcurrency').value ? parseInt($('editTokenVideoConcurrency').value) : null; if (!id) return showToast('Invalid Token ID', 'error'); if (!at) return showToast('Please enter Access Token', 'error'); const btn = $('editTokenBtn'), btnText = $('editTokenBtnText'), btnSpinner = $('editTokenBtnSpinner'); btn.disabled = true; btnText.textContent = 'Saving...'; btnSpinner.classList.remove('hidden'); try { const r = await apiRequest(`/api/tokens/${id}`, { method: 'PUT', body: JSON.stringify({ token: at, st: st || null, rt: rt || null, client_id: clientId || null, proxy_url: proxyUrl || '', remark: remark || null, image_enabled: imageEnabled, video_enabled: videoEnabled, image_concurrency: imageConcurrency, video_concurrency: videoConcurrency }) }); if (!r) { btn.disabled = false; btnText.textContent = 'Save'; btnSpinner.classList.add('hidden'); return } const d = await r.json(); if (d.success) { closeEditModal(); await refreshTokens(); showToast('Token updated successfully', 'success') } else { showToast('Update failed: ' + (d.detail || d.message || 'Unknown error'), 'error') } } catch (e) { showToast('Update failed: ' + e.message, 'error') } finally { btn.disabled = false; btnText.textContent = 'Save'; btnSpinner.classList.add('hidden') } },
            convertST2AT = async () => { const st = $('addTokenST').value.trim(); if (!st) return showToast('Please enter Session Token first', 'error'); try { showToast('Converting ST‚ÜíAT...', 'info'); const r = await apiRequest('/api/tokens/st2at', { method: 'POST', body: JSON.stringify({ st: st }) }); if (!r) return; const d = await r.json(); if (d.success && d.access_token) { $('addTokenAT').value = d.access_token; showToast('Conversion successful! AT filled automatically', 'success') } else { showToast('Conversion failed: ' + (d.message || d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Conversion failed: ' + e.message, 'error') } },
            convertRT2AT = async () => { const rt = $('addTokenRT').value.trim(); if (!rt) return showToast('Please enter Refresh Token first', 'error'); const clientId = $('addTokenClientId').value.trim(); const hint = $('addRTRefreshHint'); hint.classList.add('hidden'); try { showToast('Converting RT‚ÜíAT...', 'info'); const r = await apiRequest('/api/tokens/rt2at', { method: 'POST', body: JSON.stringify({ rt: rt, client_id: clientId || null }) }); if (!r) return; const d = await r.json(); if (d.success && d.access_token) { $('addTokenAT').value = d.access_token; if (d.refresh_token) { $('addTokenRT').value = d.refresh_token; hint.classList.remove('hidden'); showToast('Conversion successful! AT filled, RT refreshed and updated', 'success') } else { showToast('Conversion successful! AT filled automatically', 'success') } } else { showToast('Conversion failed: ' + (d.message || d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Conversion failed: ' + e.message, 'error') } },
            convertEditST2AT = async () => { const st = $('editTokenST').value.trim(); if (!st) return showToast('Please enter Session Token first', 'error'); try { showToast('Converting ST‚ÜíAT...', 'info'); const r = await apiRequest('/api/tokens/st2at', { method: 'POST', body: JSON.stringify({ st: st }) }); if (!r) return; const d = await r.json(); if (d.success && d.access_token) { $('editTokenAT').value = d.access_token; showToast('Conversion successful! AT filled automatically', 'success') } else { showToast('Conversion failed: ' + (d.message || d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Conversion failed: ' + e.message, 'error') } },
            convertEditRT2AT = async () => { const rt = $('editTokenRT').value.trim(); if (!rt) return showToast('Please enter Refresh Token first', 'error'); const clientId = $('editTokenClientId').value.trim(); const hint = $('editRTRefreshHint'); hint.classList.add('hidden'); try { showToast('Converting RT‚ÜíAT...', 'info'); const r = await apiRequest('/api/tokens/rt2at', { method: 'POST', body: JSON.stringify({ rt: rt, client_id: clientId || null }) }); if (!r) return; const d = await r.json(); if (d.success && d.access_token) { $('editTokenAT').value = d.access_token; if (d.refresh_token) { $('editTokenRT').value = d.refresh_token; hint.classList.remove('hidden'); showToast('Conversion successful! AT filled, RT refreshed and updated', 'success') } else { showToast('Conversion successful! AT filled automatically', 'success') } } else { showToast('Conversion failed: ' + (d.message || d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Conversion failed: ' + e.message, 'error') } },
            submitAddToken = async () => { const at = $('addTokenAT').value.trim(), st = $('addTokenST').value.trim(), rt = $('addTokenRT').value.trim(), clientId = $('addTokenClientId').value.trim(), proxyUrl = $('addTokenProxyUrl').value.trim(), remark = $('addTokenRemark').value.trim(), imageEnabled = $('addTokenImageEnabled').checked, videoEnabled = $('addTokenVideoEnabled').checked, imageConcurrency = parseInt($('addTokenImageConcurrency').value) || (-1), videoConcurrency = parseInt($('addTokenVideoConcurrency').value) || (-1); if (!at) return showToast('Please enter Access Token or use ST/RT conversion', 'error'); const btn = $('addTokenBtn'), btnText = $('addTokenBtnText'), btnSpinner = $('addTokenBtnSpinner'); btn.disabled = true; btnText.textContent = 'Adding...'; btnSpinner.classList.remove('hidden'); try { const r = await apiRequest('/api/tokens', { method: 'POST', body: JSON.stringify({ token: at, st: st || null, rt: rt || null, client_id: clientId || null, proxy_url: proxyUrl || '', remark: remark || null, image_enabled: imageEnabled, video_enabled: videoEnabled, image_concurrency: imageConcurrency, video_concurrency: videoConcurrency }) }); if (!r) { btn.disabled = false; btnText.textContent = 'Add'; btnSpinner.classList.add('hidden'); return } if (r.status === 409) { const d = await r.json(); const msg = d.detail || 'Token already exists'; btn.disabled = false; btnText.textContent = 'Add'; btnSpinner.classList.add('hidden'); if (confirm(msg + '\n\nDelete old Token and re-add?')) { const existingToken = allTokens.find(t => t.token === at); if (existingToken) { const deleted = await deleteToken(existingToken.id, true); if (deleted) { showToast('Re-adding...', 'info'); setTimeout(() => submitAddToken(), 500) } else { showToast('Failed to delete old Token', 'error') } } } return } const d = await r.json(); if (d.success) { closeAddModal(); await refreshTokens(); showToast('Token added successfully', 'success') } else { showToast('Add failed: ' + (d.detail || d.message || 'Unknown error'), 'error') } } catch (e) { showToast('Add failed: ' + e.message, 'error') } finally { btn.disabled = false; btnText.textContent = 'Add'; btnSpinner.classList.add('hidden') } },
            testToken = async (id) => { try { showToast('Testing Token...', 'info'); const r = await apiRequest(`/api/tokens/${id}/test`, { method: 'POST' }); if (!r) return; const d = await r.json(); if (d.success && d.status === 'success') { let msg = `Token valid! User: ${d.email || 'Unknown'}`; if (d.sora2_supported) { const remaining = d.sora2_total_count - d.sora2_redeemed_count; msg += `\nSora2: Supported (${remaining}/${d.sora2_total_count})`; if (d.sora2_remaining_count !== undefined) { msg += `\nAvailable quota: ${d.sora2_remaining_count}` } } showToast(msg, 'success'); await refreshTokens() } else { showToast(`Token invalid: ${d.message || 'Unknown error'}`, 'error') } } catch (e) { showToast('Test failed: ' + e.message, 'error') } },
            toggleToken = async (id, isActive) => { const action = isActive ? 'disable' : 'enable'; try { const r = await apiRequest(`/api/tokens/${id}/${action}`, { method: 'POST' }); if (!r) return; const d = await r.json(); d.success ? (await refreshTokens(), showToast(isActive ? 'Token disabled' : 'Token enabled', 'success')) : showToast('Operation failed', 'error') } catch (e) { showToast('Operation failed: ' + e.message, 'error') } },
            toggleTokenStatus = async (id, active) => { try { const r = await apiRequest(`/api/tokens/${id}/status`, { method: 'PUT', body: JSON.stringify({ is_active: active }) }); if (!r) return; const d = await r.json(); d.success ? (await refreshTokens(), showToast('Status updated successfully', 'success')) : showToast('Update failed', 'error') } catch (e) { showToast('Update failed: ' + e.message, 'error') } },
            deleteToken = async (id, skipConfirm = false) => { if (!skipConfirm && !confirm('Are you sure you want to delete this Token?')) return; try { const r = await apiRequest(`/api/tokens/${id}`, { method: 'DELETE' }); if (!r) return; const d = await r.json(); if (d.success) { await refreshTokens(); if (!skipConfirm) showToast('Delete successful', 'success'); return true } else { if (!skipConfirm) showToast('Delete failed', 'error'); return false } } catch (e) { if (!skipConfirm) showToast('Delete failed: ' + e.message, 'error'); return false } },
            openImportModal = () => { $('importModal').classList.remove('hidden'); $('importFile').value = '' },
            closeImportModal = () => { $('importModal').classList.add('hidden'); $('importFile').value = '' },
            openImportProgressModal = () => { $('importProgressModal').classList.remove('hidden') },
            closeImportProgressModal = () => { $('importProgressModal').classList.add('hidden') },
            openBatchProxyModal = () => { if (selectedTokenIds.size === 0) { showToast('Select tokens to update first', 'info'); return } $('batchProxyCount').textContent = selectedTokenIds.size; $('batchProxyUrl').value = ''; $('batchProxyModal').classList.remove('hidden') },
            closeBatchProxyModal = () => { $('batchProxyModal').classList.add('hidden'); $('batchProxyUrl').value = '' },
            submitBatchProxy = async () => { const proxyUrl = $('batchProxyUrl').value.trim(); const btn = $('batchProxyBtn'), btnText = $('batchProxyBtnText'), btnSpinner = $('batchProxyBtnSpinner'); btn.disabled = true; btnText.textContent = 'Updating...'; btnSpinner.classList.remove('hidden'); try { const r = await apiRequest('/api/tokens/batch/update-proxy', { method: 'POST', body: JSON.stringify({ token_ids: Array.from(selectedTokenIds), proxy_url: proxyUrl }) }); if (!r) { btn.disabled = false; btnText.textContent = 'Confirm'; btnSpinner.classList.add('hidden'); return } const d = await r.json(); if (d.success) { closeBatchProxyModal(); selectedTokenIds.clear(); await refreshTokens(); showToast(d.message, 'success') } else { showToast('Update failed: ' + (d.detail || d.message || 'Unknown error'), 'error') } } catch (e) { showToast('Update failed: ' + e.message, 'error') } finally { btn.disabled = false; btnText.textContent = 'Confirm'; btnSpinner.classList.add('hidden') } },
            showImportProgress = (results, added, updated, failed) => { const summary = $('importProgressSummary'), list = $('importProgressList'); summary.innerHTML = `<div class="text-sm"><strong>Import complete</strong><br/>Added: ${added} | Updated: ${updated} | Failed: ${failed}</div>`; list.innerHTML = results.map(r => { const statusColor = r.success ? (r.status === 'added' ? 'text-green-600' : 'text-blue-600') : 'text-red-600'; const statusText = r.status === 'added' ? 'Added' : r.status === 'updated' ? 'Updated' : 'Failed'; return `<div class="p-3 rounded-md border ${r.success ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' : 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800'}"><div class="flex items-center justify-between"><span class="font-medium">${r.email}</span><span class="${statusColor} text-sm font-medium">${statusText}</span></div>${r.error ? `<div class="text-xs text-red-600 dark:text-red-400 mt-1">${r.error}</div>` : ''}</div>` }).join(''); openImportProgressModal() },
            exportTokens = () => { if (allTokens.length === 0) { showToast('No tokens to export', 'error'); return } const exportData = allTokens.map(t => ({ email: t.email, access_token: t.token, session_token: t.st || null, refresh_token: t.rt || null, client_id: t.client_id || null, proxy_url: t.proxy_url || null, remark: t.remark || null, is_active: t.is_active, image_enabled: t.image_enabled !== false, video_enabled: t.video_enabled !== false, image_concurrency: t.image_concurrency || (-1), video_concurrency: t.video_concurrency || (-1) })); const dataStr = JSON.stringify(exportData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `tokens_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast(`Exported ${allTokens.length} tokens`, 'success') },
            batchTestUpdate = async () => { if (selectedTokenIds.size === 0) { showToast('Select tokens to test first', 'info'); return } if (!confirm(`Warning\n\nThis will query upstream for ${selectedTokenIds.size} token(s) and may take some time.\n\nContinue?`)) { return } showToast('Testing selected tokens...', 'info'); try { const r = await apiRequest('/api/tokens/batch/test-update', { method: 'POST', body: JSON.stringify({ token_ids: Array.from(selectedTokenIds) }) }); if (!r) return; const d = await r.json(); if (d.success) { selectedTokenIds.clear(); await refreshTokens(); showToast(d.message, 'success') } else { showToast('Batch test failed: ' + (d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Batch test failed: ' + e.message, 'error') } },
            batchEnableAll = async () => { if (selectedTokenIds.size === 0) { showToast('Select tokens to enable first', 'info'); return } if (!confirm(`Enable ${selectedTokenIds.size} selected token(s)?\n\nThis resets their error counts.`)) { return } showToast('Enabling tokens...', 'info'); try { const r = await apiRequest('/api/tokens/batch/enable-all', { method: 'POST', body: JSON.stringify({ token_ids: Array.from(selectedTokenIds) }) }); if (!r) return; const d = await r.json(); if (d.success) { selectedTokenIds.clear(); await refreshTokens(); showToast(d.message, 'success') } else { showToast('Batch enable failed: ' + (d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Batch enable failed: ' + e.message, 'error') } },
            batchDeleteDisabled = async () => { if (selectedTokenIds.size === 0) { showToast('Select tokens to delete first', 'info'); return } if (!confirm(`First confirmation\n\nAbout to delete ${selectedTokenIds.size} token(s).\n\nThis cannot be undone. Continue?`)) { return } if (!confirm(`Second confirmation\n\nReally delete these ${selectedTokenIds.size} token(s)?`)) { return } if (!confirm(`Final confirmation\n\nDeleting ${selectedTokenIds.size} token(s) is irreversible.\n\nProceed?`)) { return } showToast('Deleting selected tokens...', 'info'); try { const r = await apiRequest('/api/tokens/batch/delete-disabled', { method: 'POST', body: JSON.stringify({ token_ids: Array.from(selectedTokenIds) }) }); if (!r) return; const d = await r.json(); if (d.success) { selectedTokenIds.clear(); await refreshTokens(); showToast(d.message, 'success') } else { showToast('Delete failed: ' + (d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Delete failed: ' + e.message, 'error') } },
            toggleSelectAll = () => { const checkbox = $('selectAllCheckbox'); const checkboxes = document.querySelectorAll('.token-checkbox'); if (checkbox.checked) { checkboxes.forEach(cb => { cb.checked = true; const tokenId = parseInt(cb.getAttribute('data-token-id')); selectedTokenIds.add(tokenId) }) } else { checkboxes.forEach(cb => { cb.checked = false }); selectedTokenIds.clear() } },
            toggleTokenSelection = (tokenId, checked) => { if (checked) { selectedTokenIds.add(tokenId) } else { selectedTokenIds.delete(tokenId) } const allCheckboxes = document.querySelectorAll('.token-checkbox'); const allChecked = Array.from(allCheckboxes).every(cb => cb.checked); $('selectAllCheckbox').checked = allChecked },
            batchDisableSelected = async () => { if (selectedTokenIds.size === 0) { showToast('Please select tokens to disable first', 'info'); return } if (!confirm(`Are you sure you want to disable ${selectedTokenIds.size} selected tokens?`)) { return } showToast('Disabling tokens...', 'info'); try { const r = await apiRequest('/api/tokens/batch/disable-selected', { method: 'POST', body: JSON.stringify({ token_ids: Array.from(selectedTokenIds) }) }); if (!r) return; const d = await r.json(); if (d.success) { selectedTokenIds.clear(); await refreshTokens(); showToast(d.message, 'success') } else { showToast('Batch disable failed: ' + (d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Batch disable failed: ' + e.message, 'error') } },
            updateImportModeHint = () => { const mode = $('importMode').value, hint = $('importModeHint'), hints = { at: 'Use AT to update account status (Subscription, Sora2 quota, etc.)', offline: 'Offline import, account status not updated, dynamic fields shown as -', st: 'Automatically convert ST to AT, then update status', rt: 'Automatically convert RT to AT (refreshes RT), then update status' }; hint.textContent = hints[mode] || '' },
            submitImportTokens = async () => { const fileInput = $('importFile'); if (!fileInput.files || fileInput.files.length === 0) { showToast('Please select a file', 'error'); return } const file = fileInput.files[0]; if (!file.name.endsWith('.json')) { showToast('Please select a JSON file', 'error'); return } const mode = $('importMode').value; try { const fileContent = await file.text(); const importData = JSON.parse(fileContent); if (!Array.isArray(importData)) { showToast('JSON format error: should be an array', 'error'); return } if (importData.length === 0) { showToast('JSON file is empty', 'error'); return } for (let item of importData) { if (!item.email) { showToast('Import data missing required field: email', 'error'); return } if (mode === 'offline' || mode === 'at') { if (!item.access_token) { showToast(`${item.email} missing required field: access_token`, 'error'); return } } else if (mode === 'st') { if (!item.session_token) { showToast(`${item.email} missing required field: session_token`, 'error'); return } } else if (mode === 'rt') { if (!item.refresh_token) { showToast(`${item.email} missing required field: refresh_token`, 'error'); return } } } const btn = $('importBtn'), btnText = $('importBtnText'), btnSpinner = $('importBtnSpinner'); btn.disabled = true; btnText.textContent = 'Importing...'; btnSpinner.classList.remove('hidden'); try { const r = await apiRequest('/api/tokens/import', { method: 'POST', body: JSON.stringify({ tokens: importData, mode: mode }) }); if (!r) { btn.disabled = false; btnText.textContent = 'Import'; btnSpinner.classList.add('hidden'); return } const d = await r.json(); if (d.success) { closeImportModal(); await refreshTokens(); showImportProgress(d.results || [], d.added || 0, d.updated || 0, d.failed || 0) } else { showToast('Import failed: ' + (d.detail || d.message || 'Unknown error'), 'error') } } catch (e) { showToast('Import failed: ' + e.message, 'error') } finally { btn.disabled = false; btnText.textContent = 'Import'; btnSpinner.classList.add('hidden') } } catch (e) { showToast('File parsing failed: ' + e.message, 'error') } },
            loadAdminConfig = async () => { try { const r = await apiRequest('/api/admin/config'); if (!r) return; const d = await r.json(); $('cfgErrorBan').value = d.error_ban_threshold || 3; $('cfgAdminUsername').value = d.admin_username || 'admin'; $('cfgCurrentAPIKey').value = d.api_key || ''; $('cfgDebugEnabled').checked = d.debug_enabled || false } catch (e) { console.error('Failed to load config:', e) } },
            saveAdminConfig = async () => { try { const r = await apiRequest('/api/admin/config', { method: 'POST', body: JSON.stringify({ error_ban_threshold: parseInt($('cfgErrorBan').value) || 3 }) }); if (!r) return; const d = await r.json(); d.success ? showToast('Config saved successfully', 'success') : showToast('Save failed', 'error') } catch (e) { showToast('Save failed: ' + e.message, 'error') } },
            updateAdminPassword = async () => { const username = $('cfgAdminUsername').value.trim(), oldPwd = $('cfgOldPassword').value.trim(), newPwd = $('cfgNewPassword').value.trim(); if (!oldPwd || !newPwd) return showToast('Please enter old and new passwords', 'error'); if (newPwd.length < 4) return showToast('New password must be at least 4 characters', 'error'); try { const r = await apiRequest('/api/admin/password', { method: 'POST', body: JSON.stringify({ username: username || undefined, old_password: oldPwd, new_password: newPwd }) }); if (!r) return; const d = await r.json(); if (d.success) { showToast('Password modified successfully, please log in again', 'success'); setTimeout(() => { localStorage.removeItem('adminToken'); location.href = '/login' }, 2000) } else { showToast('Modification failed: ' + (d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Modification failed: ' + e.message, 'error') } },
            updateAPIKey = async () => { const newKey = $('cfgNewAPIKey').value.trim(); if (!newKey) return showToast('Please enter new API Key', 'error'); if (newKey.length < 6) return showToast('API Key must be at least 6 characters', 'error'); if (!confirm('Are you sure you want to update the API Key? All clients will need to be notified of the new key.')) return; try { const r = await apiRequest('/api/admin/apikey', { method: 'POST', body: JSON.stringify({ new_api_key: newKey }) }); if (!r) return; const d = await r.json(); if (d.success) { showToast('API Key updated successfully', 'success'); $('cfgCurrentAPIKey').value = newKey; $('cfgNewAPIKey').value = '' } else { showToast('Update failed: ' + (d.detail || 'Unknown error'), 'error') } } catch (e) { showToast('Update failed: ' + e.message, 'error') } },
            toggleDebugMode = async () => { const enabled = $('cfgDebugEnabled').checked; try { const r = await apiRequest('/api/admin/debug', { method: 'POST', body: JSON.stringify({ enabled: enabled }) }); if (!r) return; const d = await r.json(); if (d.success) { showToast(enabled ? 'Debug mode enabled' : 'Debug mode disabled', 'success') } else { showToast('Operation failed: ' + (d.detail || 'Unknown error'), 'error'); $('cfgDebugEnabled').checked = !enabled } } catch (e) { showToast('Operation failed: ' + e.message, 'error'); $('cfgDebugEnabled').checked = !enabled } },
            downloadDebugLogs = async () => { try { const token = localStorage.getItem('adminToken'); if (!token) { showToast('Not logged in', 'error'); return } const r = await fetch('/api/admin/logs/download', { headers: { Authorization: `Bearer ${token}` } }); if (!r.ok) { if (r.status === 404) { showToast('Log file does not exist', 'error') } else { showToast('Download failed', 'error') } return } const blob = await r.blob(); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `logs_${new Date().toISOString().split('T')[0]}.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast('Log file downloaded successfully', 'success') } catch (e) { showToast('Download failed: ' + e.message, 'error') } },
            loadProxyConfig = async () => { try { const r = await apiRequest('/api/proxy/config'); if (!r) return; const d = await r.json(); $('cfgProxyEnabled').checked = d.proxy_enabled || false; $('cfgProxyUrl').value = d.proxy_url || '' } catch (e) { console.error('Failed to load proxy config:', e) } },
            saveProxyConfig = async () => { try { const r = await apiRequest('/api/proxy/config', { method: 'POST', body: JSON.stringify({ proxy_enabled: $('cfgProxyEnabled').checked, proxy_url: $('cfgProxyUrl').value.trim() }) }); if (!r) return; const d = await r.json(); d.success ? showToast('Proxy config saved successfully', 'success') : showToast('Save failed', 'error') } catch (e) { showToast('Save failed: ' + e.message, 'error') } },
            loadWatermarkFreeConfig = async () => { try { const [r1, r2] = await Promise.all([apiRequest('/api/watermark-free/config'), apiRequest('/api/android-credentials')]); if (r1) { const d = await r1.json(); $('cfgWatermarkFreeEnabled').checked = d.watermark_free_enabled || false; $('cfgParseMethod').value = d.parse_method || 'third_party'; } if (r2) { const d = await r2.json(); if (d.success && d.data) { $('cfgAndroidAuthToken').value = d.data.sora_auth_token || ''; $('cfgAndroidRefreshToken').value = d.data.sora_refresh_token || ''; $('cfgAndroidClientId').value = d.data.sora_client_id || 'app_OHnYmJt5u1XEdhDUx0ig1ziv'; } } toggleWatermarkFreeOptions(); toggleCustomParseOptions() } catch (e) { console.error('Failed to load watermark-free config:', e) } },
            saveWatermarkFreeConfig = async () => { try { const enabled = $('cfgWatermarkFreeEnabled').checked, parseMethod = $('cfgParseMethod').value; const androidAuth = $('cfgAndroidAuthToken').value.trim(), androidRefresh = $('cfgAndroidRefreshToken').value.trim(), androidClient = ($('cfgAndroidClientId').value || '').trim() || 'app_OHnYmJt5u1XEdhDUx0ig1ziv'; if (enabled && parseMethod === 'custom') { if (!androidAuth) return showToast('Please enter Android Access Token', 'error'); if (!androidRefresh) return showToast('Please enter Android Refresh Token', 'error'); } const r1 = await apiRequest('/api/watermark-free/config', { method: 'POST', body: JSON.stringify({ watermark_free_enabled: enabled, parse_method: parseMethod }) }); if (!r1) return; const d1 = await r1.json(); if (!d1.success) { return showToast('Save failed', 'error') } if (enabled && parseMethod === 'custom') { const r2 = await apiRequest('/api/android-credentials', { method: 'POST', body: JSON.stringify({ sora_auth_token: androidAuth, sora_refresh_token: androidRefresh, sora_client_id: androidClient }) }); if (r2) { const d2 = await r2.json(); if (d2.success) { showToast('Watermark-free config saved', 'success') } else { showToast(d2.detail || d2.message || 'Failed to save Android credentials', 'error') } } } else { showToast('Watermark-free config saved', 'success') } } catch (e) { showToast('Save failed: ' + e.message, 'error') } },
            toggleWatermarkFreeOptions = () => { const enabled = $('cfgWatermarkFreeEnabled').checked; $('watermarkFreeOptions').style.display = enabled ? 'block' : 'none' },
            toggleCustomParseOptions = () => { const method = $('cfgParseMethod').value; $('customParseOptions').style.display = method === 'custom' ? 'block' : 'none' },
            toggleCacheOptions = () => { const enabled = $('cfgCacheEnabled').checked; $('cacheOptions').style.display = enabled ? 'block' : 'none' },
            loadCacheConfig = async () => { try { const r = await apiRequest('/api/cache/config'); if (!r) return; const d = await r.json(); if (d.success && d.config) { $('cfgCacheEnabled').checked = d.config.enabled !== false; $('cfgCacheTimeout').value = d.config.timeout || 7200; $('cfgCacheBaseUrl').value = d.config.base_url || ''; if (d.config.effective_base_url) { $('cacheEffectiveUrlValue').textContent = d.config.effective_base_url; $('cacheEffectiveUrl').classList.remove('hidden') } else { $('cacheEffectiveUrl').classList.add('hidden') } toggleCacheOptions(); } } catch (e) { showToast('Failed to load cache config: ' + e.message, 'error') } },
            loadGenerationTimeout = async () => { try { const r = await apiRequest('/api/generation/timeout'); if (!r) return; const d = await r.json(); if (d.success && d.config) { $('cfgImageTimeout').value = d.config.image_timeout || 300; $('cfgVideoTimeout').value = d.config.video_timeout || 1500; } } catch (e) { showToast('Failed to load generation timeout: ' + e.message, 'error') } },
            saveCacheConfig = async () => { const enabled = $('cfgCacheEnabled').checked, timeout = parseInt($('cfgCacheTimeout').value) || 7200, baseUrl = $('cfgCacheBaseUrl').value.trim(); if (timeout !== -1 && (timeout < 60 || timeout > 86400)) return showToast('Cache timeout must be between 60-86400 seconds, or -1 for never', 'error'); if (baseUrl && !baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) return showToast('Domain must start with http:// or https://', 'error'); try { const r0 = await apiRequest('/api/cache/enabled', { method: 'POST', body: JSON.stringify({ enabled: enabled }) }); if (!r0) return; const d0 = await r0.json(); if (!d0.success) return showToast('Failed to save cache enabled status', 'error'); const r1 = await apiRequest('/api/cache/config', { method: 'POST', body: JSON.stringify({ timeout: timeout }) }); if (!r1) return; const d1 = await r1.json(); if (!d1.success) return showToast('Failed to save timeout', 'error'); const r2 = await apiRequest('/api/cache/base-url', { method: 'POST', body: JSON.stringify({ base_url: baseUrl }) }); if (!r2) return; const d2 = await r2.json(); if (d2.success) { showToast('Cache config saved successfully', 'success'); await new Promise(r => setTimeout(r, 200)); await loadCacheConfig() } else { showToast('Failed to save domain', 'error') } } catch (e) { showToast('Save failed: ' + e.message, 'error') } },
            saveGenerationTimeout = async () => { const imageTimeout = parseInt($('cfgImageTimeout').value) || 300, videoTimeout = parseInt($('cfgVideoTimeout').value) || 1500; if (imageTimeout < 60 || imageTimeout > 3600) return showToast('Image timeout must be between 60-3600 seconds', 'error'); if (videoTimeout < 60 || videoTimeout > 7200) return showToast('Video timeout must be between 60-7200 seconds', 'error'); try { const r = await apiRequest('/api/generation/timeout', { method: 'POST', body: JSON.stringify({ image_timeout: imageTimeout, video_timeout: videoTimeout }) }); if (!r) return; const d = await r.json(); if (d.success) { showToast('Generation timeout config saved successfully', 'success'); await new Promise(r => setTimeout(r, 200)); await loadGenerationTimeout() } else { showToast('Save failed', 'error') } } catch (e) { showToast('Save failed: ' + e.message, 'error') } },
            toggleATAutoRefresh = async () => { try { const enabled = $('atAutoRefreshToggle').checked; const r = await apiRequest('/api/token-refresh/enabled', { method: 'POST', body: JSON.stringify({ enabled: enabled }) }); if (!r) { $('atAutoRefreshToggle').checked = !enabled; return } const d = await r.json(); if (d.success) { showToast(enabled ? 'AT auto-refresh enabled' : 'AT auto-refresh disabled', 'success') } else { showToast('Operation failed: ' + (d.detail || 'Unknown error'), 'error'); $('atAutoRefreshToggle').checked = !enabled } } catch (e) { showToast('Operation failed: ' + e.message, 'error'); $('atAutoRefreshToggle').checked = !enabled } },
            loadATAutoRefreshConfig = async () => { try { const r = await apiRequest('/api/token-refresh/config'); if (!r) return; const d = await r.json(); if (d.success && d.config) { $('atAutoRefreshToggle').checked = d.config.at_auto_refresh_enabled || false } else { console.error('AT auto-refresh config format error:', d) } } catch (e) { console.error('Failed to load AT auto-refresh config:', e) } },
            loadLogs = async () => { try { const r = await apiRequest('/api/logs?limit=100'); if (!r) return; const logs = await r.json(); window.allLogs = logs; const tb = $('logsTableBody'); tb.innerHTML = logs.map(l => { const isProcessing = l.status_code === -1; const statusText = isProcessing ? 'Processing' : l.status_code; const statusClass = isProcessing ? 'bg-blue-50 text-blue-700' : l.status_code === 200 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'; let progressHtml = '<span class="text-xs text-muted-foreground">-</span>'; if (isProcessing && l.task_status) { const taskStatusMap = { processing: 'Generating', completed: 'Completed', failed: 'Failed' }; const taskStatusText = taskStatusMap[l.task_status] || l.task_status; const progress = l.progress || 0; progressHtml = `<div class="flex flex-col gap-1"><div class="flex items-center gap-2"><div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-blue-500 transition-all" style="width:${progress}%"></div></div><span class="text-xs text-blue-600">${progress.toFixed(0)}%</span></div><span class="text-xs text-muted-foreground">${taskStatusText}</span></div>` } let actionHtml = '<button onclick="showLogDetail(' + l.id + ')" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs">View</button>'; if (isProcessing && l.task_id) { actionHtml = '<div class="flex gap-1"><button onclick="showLogDetail(' + l.id + ')" class="inline-flex items-center justify-center rounded-md hover:bg-blue-50 hover:text-blue-700 h-7 px-2 text-xs">View</button><button onclick="cancelTask(\'' + l.task_id + '\')" class="inline-flex items-center justify-center rounded-md hover:bg-red-50 hover:text-red-700 h-7 px-2 text-xs">Terminate</button></div>' } return `<tr><td class="py-2.5 px-3">${l.operation}</td><td class="py-2.5 px-3"><span class="text-xs ${l.token_email ? 'text-blue-600' : 'text-muted-foreground'}">${l.token_email || 'Unknown'}</span></td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${statusClass}">${statusText}</span></td><td class="py-2.5 px-3"><span class="text-xs font-mono text-muted-foreground">${l.watermark_method || '-'}</span></td><td class="py-2.5 px-3">${progressHtml}</td><td class="py-2.5 px-3">${l.duration === -1 ? 'Processing' : l.duration.toFixed(2) + 's'}</td><td class="py-2.5 px-3 text-xs text-muted-foreground">${l.created_at ? new Date(l.created_at).toLocaleString('en-US') : '-'}</td><td class="py-2.5 px-3">${actionHtml}</td></tr>` }).join('') } catch (e) { console.error('Failed to load logs:', e) } },
            refreshLogs = async () => { await loadLogs() },
            showLogDetail = (logId) => { const log = window.allLogs.find(l => l.id === logId); if (!log) { showToast('Log does not exist', 'error'); return } const content = $('logDetailContent'); let detailHtml = ''; if (log.status_code === -1) { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm text-blue-600">Generation Progress</h4><div class="rounded-md border border-blue-200 p-3 bg-blue-50"><p class="text-sm text-blue-700">Task is being generated...</p>${log.task_status ? `<p class="text-xs text-blue-600 mt-1">Status: ${log.task_status}</p>` : ''}</div></div>` } else if (log.status_code === 200) { try { const responseBody = log.response_body ? JSON.parse(log.response_body) : null; if (responseBody) { if (responseBody.data && responseBody.data.length > 0) { const item = responseBody.data[0]; if (item.url) { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm">Generation Result</h4><div class="rounded-md border border-border p-3 bg-muted/30"><p class="text-sm mb-2"><span class="font-medium">File URL:</span></p><a href="${item.url}" target="_blank" class="text-blue-600 hover:underline text-xs break-all">${item.url}</a></div></div>` } else { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm">Response Data</h4><pre class="rounded-md border border-border p-3 bg-muted/30 text-xs overflow-x-auto">${JSON.stringify(responseBody, null, 2)}</pre></div>` } } else { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm">Response Data</h4><pre class="rounded-md border border-border p-3 bg-muted/30 text-xs overflow-x-auto">${JSON.stringify(responseBody, null, 2)}</pre></div>` } } else { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm">Response Info</h4><p class="text-sm text-muted-foreground">No response data</p></div>` } } catch (e) { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm">Response Data</h4><pre class="rounded-md border border-border p-3 bg-muted/30 text-xs overflow-x-auto">${log.response_body || 'None'}</pre></div>` } } else { try { const responseBody = log.response_body ? JSON.parse(log.response_body) : null; if (responseBody && responseBody.error) { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm text-red-600">Error Reason</h4><div class="rounded-md border border-red-200 p-3 bg-red-50"><p class="text-sm text-red-700">${responseBody.error.message || responseBody.error || 'Unknown error'}</p></div></div>` } else if (log.response_body && log.response_body !== '{}') { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm text-red-600">Error Message</h4><pre class="rounded-md border border-red-200 p-3 bg-red-50 text-xs overflow-x-auto">${log.response_body}</pre></div>` } } catch (e) { if (log.response_body && log.response_body !== '{}') { detailHtml += `<div class="space-y-2"><h4 class="font-medium text-sm text-red-600">Error Message</h4><pre class="rounded-md border border-red-200 p-3 bg-red-50 text-xs overflow-x-auto">${log.response_body}</pre></div>` } } } detailHtml += `<div class="space-y-2 pt-4 border-t border-border"><h4 class="font-medium text-sm">Basic Information</h4><div class="grid grid-cols-2 gap-2 text-sm"><div><span class="text-muted-foreground">Operation:</span> ${log.operation}</div><div><span class="text-muted-foreground">Status Code:</span> <span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${log.status_code === -1 ? 'bg-blue-50 text-blue-700' : log.status_code === 200 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">${log.status_code === -1 ? 'Generating' : log.status_code}</span></div><div><span class="text-muted-foreground">Duration:</span> ${log.duration === -1 ? 'Generating' : log.duration.toFixed(2) + 's'}</div><div><span class="text-muted-foreground">Time:</span> ${log.created_at ? new Date(log.created_at).toLocaleString('en-US') : '-'}</div></div></div>`; content.innerHTML = detailHtml; $('logDetailModal').classList.remove('hidden') },
            closeLogDetailModal = () => { $('logDetailModal').classList.add('hidden') },
            clearAllLogs = async () => { if (!confirm('Are you sure you want to clear all logs? This operation is irreversible!')) return; try { const r = await apiRequest('/api/logs', { method: 'DELETE' }); if (!r) return; const d = await r.json(); if (d.success) { showToast('Logs cleared', 'success'); await loadLogs() } else { showToast('Clear failed: ' + (d.message || 'Unknown error'), 'error') } } catch (e) { showToast('Clear failed: ' + e.message, 'error') } },
            cancelTask = async (taskId) => { if (!confirm('Are you sure you want to terminate this task?')) return; try { const r = await apiRequest(`/api/tasks/${taskId}/cancel`, { method: 'POST' }); if (!r) return; const d = await r.json(); if (d.success) { showToast('Task terminated', 'success'); await loadLogs() } else { showToast('Termination failed: ' + (d.message || 'Unknown error'), 'error') } } catch (e) { showToast('Termination failed: ' + e.message, 'error') } },
            showToast = (m, t = 'info') => { const d = document.createElement('div'), bc = { success: 'bg-green-600', error: 'bg-destructive', info: 'bg-primary' }; d.className = `fixed bottom-4 right-4 ${bc[t] || bc.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50 animate-slide-up`; d.textContent = m; document.body.appendChild(d); setTimeout(() => { d.style.opacity = '0'; d.style.transition = 'opacity .3s'; setTimeout(() => d.parentNode && document.body.removeChild(d), 300) }, 2000) },
            logout = () => { if (!confirm('Are you sure you want to log out?')) return; localStorage.removeItem('adminToken'); location.href = '/login' },
            loadCharacters = async () => { try { const r = await apiRequest('/api/characters'); if (!r) return; const d = await r.json(); const g = $('charactersGrid'); if (!d || d.length === 0) { g.innerHTML = '<div class="col-span-full text-center py-8 text-muted-foreground">No character cards available</div>'; return } g.innerHTML = d.map(c => `<div class="rounded-lg border border-border bg-background p-4"><div class="flex items-start gap-3"><img src="${c.avatar_path || '/static/favicon.ico'}" class="h-14 w-14 rounded-lg object-cover" onerror="this.src='/static/favicon.ico'"/><div class="flex-1 min-w-0"><div class="font-semibold truncate">${c.display_name || c.username}</div><div class="text-xs text-muted-foreground truncate">@${c.username}</div>${c.description ? `<div class="text-xs text-muted-foreground mt-1 line-clamp-2">${c.description}</div>` : ''}</div></div><div class="mt-3 flex gap-2"><button onclick="deleteCharacter(${c.id})" class="flex-1 inline-flex items-center justify-center rounded-md border border-destructive text-destructive hover:bg-destructive hover:text-white h-8 px-3 text-sm transition-colors">Delete</button></div></div>`).join('') } catch (e) { showToast('Load failed: ' + e.message, 'error') } },
            deleteCharacter = async (id) => { if (!confirm('Are you sure you want to delete this character card?')) return; try { const r = await apiRequest(`/api/characters/${id}`, { method: 'DELETE' }); if (!r) return; const d = await r.json(); if (d.success) { showToast('Delete successful', 'success'); await loadCharacters() } else { showToast('Delete failed', 'error') } } catch (e) { showToast('Delete failed: ' + e.message, 'error') } },
            switchTab = t => { const cap = n => n.charAt(0).toUpperCase() + n.slice(1);['tokens', 'settings', 'logs', 'generate'].forEach(n => { const active = n === t; $(`panel${cap(n)}`).classList.toggle('hidden', !active); $(`tab${cap(n)}`).classList.toggle('border-primary', active); $(`tab${cap(n)}`).classList.toggle('text-primary', active); $(`tab${cap(n)}`).classList.toggle('border-transparent', !active); $(`tab${cap(n)}`).classList.toggle('text-muted-foreground', !active) }); if (t === 'settings') { loadAdminConfig(); loadProxyConfig(); loadWatermarkFreeConfig(); loadCacheConfig(); loadGenerationTimeout(); loadATAutoRefreshConfig() } else if (t === 'logs') { loadLogs() } };
        // Adaptive height for generation panel iframe
        window.addEventListener('message', (event) => {
            const data = event.data || {};
            if (data.type === 'sora-generate-height' && typeof data.height === 'number') {
                const iframe = document.getElementById('generateFrame');
                if (iframe) {
                    const nextH = Math.max(560, Math.ceil(data.height) + 8);
                    iframe.style.height = `${nextH}px`;
                }
            }
        });
        window.addEventListener('DOMContentLoaded', () => { checkAuth(); refreshTokens(); loadATAutoRefreshConfig() });
    </script>
</body>

</html>